<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="generator" content=
"HTML Tidy for HTML5 for Apple macOS version 5.8.0">
<!-- 2024-11-06 Wed 21:27 -->
<meta name="viewport" content=
"width=device-width, initial-scale=1">
<title>2024年，用Mutt来处理邮件</title>
<meta name="author" content="RadioNoiseE">
<meta name="generator" content="Org Mode">
<link rel="stylesheet" type="text/css" href="../style/article.css">
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">2024年，用Mutt来处理邮件</h1>
</header>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org4ea4a88">1. 写在前面</a></li>
<li><a href="#org182e4a8">2. 安装</a></li>
<li><a href="#org0ddb6fc">3. 配置</a>
<ul>
<li><a href="#orgf1287b0">3.1. 接收邮件</a></li>
<li><a href="#org4127b00">3.2. 发送邮件</a></li>
<li><a href="#orgacbdc0a">3.3. MIME</a>
<ul>
<li><a href="#org125afac">3.3.1. HTML邮件</a></li>
<li><a href="#org2aeb33e">3.3.2. 其他格式</a></li>
</ul>
</li>
<li><a href="#orgaccabaf">3.4. 优化</a></li>
</ul>
</li>
<li><a href="#org8a6feb7">4. 最后</a></li>
</ul>
</div>
</nav>
<blockquote>
<p>“All mail clients suck. This one just sucks less.” — Michael
Elkins, circa 1995</p>
</blockquote>
<div id="outline-container-org4ea4a88" class="outline-2">
<h2 id="org4ea4a88"><span class="section-number-2">1.</span>
写在前面</h2>
<div class="outline-text-2" id="text-1">
<p>处理邮件，我之前一直用的是ThunderBird，所谓「Mozilla's solution to mail
client」。它的界面很好看，然而真的很重，而且当发送的邮件中有尺寸较大的附件时的体验一直很差，会一直卡着。直到三天前，我用它接收一个使用邮件传送的9MiB的附件时，它的进度蓝条卡了半个小时还没将页面加载出来，同时还把切换其他信息的动作卡住了。这时我才真正意识到了什么叫「All
mail clients suck」，并打算换一个；试了试号称「sucks
less」的Mutt，感觉情况的确比之前有较大改善。</p>
<figure id="orgf992506"><img src=
"../static/image/mutt-intro-01.png" alt="mutt-intro-01.png"
loading="lazy" class="img-center" width="85%">
<figcaption><span class="figure-number">Figure 1:</span>
界面</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org182e4a8" class="outline-2">
<h2 id="org182e4a8"><span class="section-number-2">2.</span>
安装</h2>
<div class="outline-text-2" id="text-2">
<p>Gentoo用户需要启用这些USE旗标：</p>
<pre class="example">
+ + hcache        : Enable header cache, one database backend needs to be enabled
+ + lmdb          : Enable dev-db/lmdb database backend for header caching
+ + slang         : Add support for the slang text display library (it's like ncurses, but different)
+ + smtp          : Enable support for direct SMTP delivery
+ + imap          : Add support for IMAP (Internet Mail Application Protocol)
+ + ssl           : Add support for SSL/TLS connections (Secure Socket Layer / Transport Layer Security)
</pre>
<p>
其中，<code>lmdb</code>和<code>hcache</code>是头字段缓存，可选。<code>smtp</code>和<code>imap</code>是其支持的两种协议，你需要查阅文档看一下你的邮件服务供应商支持什么协议；<code>ssl</code>同理。至于<code>slang</code>是一个TUI框架，我只是想试试，你可以保持默认。</p>
</div>
</div>
<div id="outline-container-org0ddb6fc" class="outline-2">
<h2 id="org0ddb6fc"><span class="section-number-2">3.</span>
配置</h2>
<div class="outline-text-2" id="text-3"></div>
<div id="outline-container-orgf1287b0" class="outline-3">
<h3 id="orgf1287b0"><span class="section-number-3">3.1.</span>
接收邮件</h3>
<div class="outline-text-3" id="text-3-1">
<p>
因为我使用iCloud邮箱，故使用的是<code>imap</code>协议。于<code>~/.config/mutt/muttrc</code>下创建配置文件，并添加如下：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">unset</span> imap_passive
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">mail_check</span> = 60
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">imap_keepalive</span> = 300
</pre></div>
<p>上面控制其行为准则。</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> <span style=
"color: #a0522d;">realname</span> = <span style=
"color: #8b2252;">"{NAME}"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">imap_user</span> = <span style=
"color: #8b2252;">"{USER}"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">imap_pass</span> = <span style=
"color: #8b2252;">"{PASSWD}"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">from</span> = <span style=
"color: #8b2252;">"{EADDR}"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">folder</span> = <span style=
"color: #8b2252;">"imaps://{USER}@imap.mail.me.com:{PORT}/"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">spoolfile</span> = <span style=
"color: #8b2252;">"+Inbox"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">postponed</span> = <span style=
"color: #8b2252;">"+Drafts"</span>
</pre></div>
<p>需根据你的邮箱服务供应商而定。比如iCloud，你需要生成一个app-specific的密码。</p>
</div>
</div>
<div id="outline-container-org4127b00" class="outline-3">
<h3 id="org4127b00"><span class="section-number-3">3.2.</span>
发送邮件</h3>
<div class="outline-text-3" id="text-3-2">
<p>一般使用<code>smtp</code>协议。如下：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> <span style=
"color: #a0522d;">smtp_url</span> = <span style=
"color: #8b2252;">"smtp://{USER}@smtp.mail.me.com:{PORT}/"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">smtp_pass</span> = $<span style=
"color: #a0522d;">imap_pass</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">ssl_force_tls</span> = yes
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">record</span> = <span style=
"color: #8b2252;">"+Sent Messages"</span>
</pre></div>
</div>
</div>
<div id="outline-container-orgacbdc0a" class="outline-3">
<h3 id="orgacbdc0a"><span class="section-number-3">3.3.</span>
MIME</h3>
<div class="outline-text-3" id="text-3-3">
<p>邮件里经常会夹带各种奇奇怪怪的附件，而对这些附件的处理正是Mutt做的不错而ThunderBird略有不足之处。</p>
</div>
<div id="outline-container-org125afac" class="outline-4">
<h4 id="org125afac"><span class="section-number-4">3.3.1.</span>
HTML邮件</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
这是最特殊的一个，所以单独出来说。由于Mutt最多就是个TUI界面，不要指望它的HTML邮件预览能力跟ThunderBird对齐；话虽如此，它的支持还是不错的。</p>
<p>
它自己只负责接受邮件，而将HTML渲染则是外部程序的事情。它可以使用一切程序，但常见的有lynx和w3m。这里使用w3m，因为它在我的系统上已经被安装了。</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> <span style=
"color: #a0522d;">mailcap_path</span> = <span style=
"color: #8b2252;">"~/.config/mutt/mailcap"</span>
auto_view text/html
</pre></div>
<p>随后我们创建负责MIME的配置文件，路径与上面<code>mailcap_path</code>指定的一致，添加：</p>
<div class="org-src-container">
<pre class=
"src src-shell">text/html; w3m -I %{charset} -T text/html; copiousoutput;
</pre></div>
</div>
</div>
<div id="outline-container-org2aeb33e" class="outline-4">
<h4 id="org2aeb33e"><span class="section-number-4">3.3.2.</span>
其他格式</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
依照HTML预览，不难理解Mutt处理MIME的原理。不同之处在于其他格式可能无法在TUI界面中预览。比如图像，也许用Uberzug++是可行的，但更好的方法还是用正经的图像预览工具去查看他们。这就带来了一个问题，Mutt默认的预览附件的行为是阻塞的，就跟你在vim里执行不带<code>&</code>的壳命令一样；而如果你使用<code>&</code>，由于Mutt会在退出后删除临时存储的附件，导致无法预览。</p>
<p>明白问题后就不难解决。我们只需要将这个要预览的文件复制以下即可。创建如下脚本：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #b22222;">#</span><span style=
"color: #b22222;">!/bin/</span><span style=
"color: #a020f0;">sh</span>

<span style="color: #a0522d;">t</span>=/tmp/muttach
mkdir -p $<span style="color: #a0522d;">t</span>
<span style="color: #a0522d;">f</span>=<span style=
"color: #ff00ff;">`basename $2`</span>
<span style="color: #a0522d;">n</span>=$<span style=
"color: #a0522d;">t</span>/$<span style="color: #a0522d;">f</span>

cp $<span style="color: #a0522d;">2</span> $<span style=
"color: #a0522d;">n</span>
$<span style="color: #a0522d;">1</span> $<span style=
"color: #a0522d;">n</span> &amp;&gt;/dev/null &
</pre></div>
<p>将它放入<code>$PATH</code>后，即可在<code>mailcap</code>中如此使用：</p>
<div class="org-src-container">
<pre class="src src-shell">application/pdf; muttach gv %s;
image/*; muttach imv %s;
audio/*; muttach mpv %s;
video/*; muttach mpv %s;
</pre></div>
<figure id="orgf0adc1d"><img src=
"../static/image/mutt-intro-02.png" alt="mutt-intro-02.png"
loading="lazy" class="img-center" width="85%">
<figcaption><span class="figure-number">Figure 2:</span>
预览PDF</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-orgaccabaf" class="outline-3">
<h3 id="orgaccabaf"><span class="section-number-3">3.4.</span>
优化</h3>
<div class="outline-text-3" id="text-3-4">
<p>默认的Headers很多，大概率我们不需要看到那些，于是我们：</p>
<div class="org-src-container">
<pre class="src src-shell">ignore          *
unignore        From To Cc Bcc Date Subject X-face
unhdr_order     *
hdr_order       From: To: Cc: Bcc: Date: Subject: X-Face:
</pre></div>
<p>为了加快响应速度，我们缓存：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> <span style=
"color: #a0522d;">header_cache</span> = <span style=
"color: #8b2252;">"/var/tmp/mutt"</span>
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">message_cachedir</span> = <span style=
"color: #8b2252;">"/var/tmp/mutt"</span>
</pre></div>
<p>我们启用侧边栏：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> <span style=
"color: #a0522d;">sidebar_visible</span> = yes
<span style="color: #483d8b;">set</span> <span style=
"color: #a0522d;">sidebar_sort_method</span> = alpha
bind index,pager &lt;Esc&gt;k sidebar-prev
bind index,pager &lt;Esc&gt;j sidebar-next
bind index,pager &lt;Esc&gt;o sidebar-open
bind index,pager &lt;Esc&gt;u sidebar-page-up
bind index,pager &lt;Esc&gt;d sidebar-page-down
</pre></div>
<p>为了让侧边栏有内容，我们偷懒：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> imap_check_subscribed
</pre></div>
<p>更方便地查看：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> <span style=
"color: #a0522d;">pager_index_lines</span> = 4
</pre></div>
<p>更不错的状态：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #483d8b;">set</span> <span style=
"color: #a0522d;">pager_format</span> = <span style=
"color: #8b2252;">" %C - %[%H:%M] %.20v, %s%* %?H? [%H] ?"</span>
</pre></div>
<p>以及颜色（色彩高亮），各位可以参考<a href=
"http://aperiodic.net/phil/configs/mutt/colors">这个</a>。</p>
</div>
</div>
</div>
<div id="outline-container-org8a6feb7" class="outline-2">
<h2 id="org8a6feb7"><span class="section-number-2">4.</span>
最后</h2>
<div class="outline-text-2" id="text-4">
<p>颅内高潮：</p>
<div class="org-src-container">
<pre class=
"src src-shell">my_hdr X-Face: *[&gt;eDAPM?U?Cx<span style=
"color: #8b2252;">\$</span>/6HNmXzNCNhzKU<span style=
"color: #8b2252;">\#</span>:oG<span style=
"color: #8b2252;">\#</span>(lw!uh<span style=
"color: #8b2252;">\$</span><span style=
"color: #a0522d;">7</span>nMD%<span style=
"color: #8b2252;">\$</span>{/&lt;.wk(<span style=
"color: #483d8b;">r</span>!3C(xNhV.EN!+uOUMq7]/H?Lk98rZl<span style="color: #8b2252;">\"</span>:690@*gjH@zEz{R<span style="color: #8b2252;">\$</span><span style="color: #a0522d;">IuVJlhnlc</span>.0?*BJhGy5N]Fv9D)vv-~-6yg,<span style="color: #8b2252;">\\\$</span><span style="color: #a0522d;">lYpE</span>.qk=1FR!K1!3+Ec]L<span style="color: #8b2252;">\`</span>~eC,<span style="color: #a0522d;">m6bFeXJb</span>-=<span style="color: #8b2252;">\$</span><span style="color: #a0522d;">fWylGg3</span>+ALBb<span style="color: #8b2252;">\'</span>jhg1z8j7G?dT]@LIt,~LzO,v<span style="color: #8b2252;">\"</span>nNOW3a%Y<span style="color: #8b2252;">\\</span>5F|id}n*k&gt;2:d&gt;bhAvcA)QM%?<span style="color: #8b2252;">\\</span>Xe1A<span style="color: #8b2252;">\'</span>&gt;jp9FV*k*@Q(?NhDVT<span style="color: #8b2252;">\`</span>32j-YGEe?d<span style="color: #8b2252;">\\</span>Y+A@w/<span style="color: #8b2252;">\$</span>,EGL^!,w5Dr<span style="color: #8b2252;">\$</span><span style="color: #a0522d;">x</span>|ncyr}|Tt^+D.@?uAaHk8T~HZl8U0q
</pre></div>
<p>警告：请不要用我的，谢谢。</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: RadioNoiseE</p>
<p class="date">Created: 2024-11-06 Wed 21:27</p>
<p class="validation"><a href=
"https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
