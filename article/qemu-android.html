<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="generator" content=
"HTML Tidy for HTML5 for Apple macOS version 5.8.0">
<!-- 2024-11-06 Wed 21:27 -->
<meta name="viewport" content=
"width=device-width, initial-scale=1">
<title>Linux下基于QEMU的纯净Android虚拟机（KVMとVirGL、小足印）</title>
<meta name="author" content="RadioNoiseE">
<meta name="generator" content="Org Mode">
<link rel="stylesheet" type="text/css" href="../style/article.css">
</head>
<body>
<div id="content" class="content">
<header>
<h1 class="title">Linux下基于QEMU的纯净Android虚拟机（KVMとVirGL、小足印）</h1>
</header>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org414d873">1. 写在前面</a></li>
<li><a href="#org1d2291c">2.
安装有KVM／VirGL和SDL支持的QEMU（非Gentoo用家可跳过）</a>
<ul>
<li><a href="#org689b414">2.1. 本体</a></li>
<li><a href="#org692eff9">2.2. EDK II OVMF</a></li>
</ul>
</li>
<li><a href="#org67bcbd4">3. 取得Android-x86系统镜像</a></li>
<li><a href="#orga683b58">4. 安装虚拟机</a>
<ul>
<li><a href="#org6b508a1">4.1. 启动脚本</a></li>
<li><a href="#org30691c7">4.2. 创建虚拟磁盘</a></li>
<li><a href="#orgd736c27">4.3. 安装</a></li>
</ul>
</li>
<li><a href="#org2ac295b">5. 优化／配置</a>
<ul>
<li><a href="#orgac559f8">5.1. 调整屏幕分辨率／尺寸参数</a></li>
</ul>
</li>
<li><a href="#orged0666a">6. 写在最后</a></li>
</ul>
</div>
</nav>
<div id="outline-container-org414d873" class="outline-2">
<h2 id="org414d873"><span class="section-number-2">1.</span>
写在前面</h2>
<div class="outline-text-2" id="text-1">
<p>
最近有在电脑上玩明日方舟的需求，因为是Linux电脑、模拟iOS是不现实的，所以打算搭一个安卓虚拟机。至于为什么不用WayDroid，主要是因为它的Makefile似乎只支持SystemD系统、同时需要内核支持（显得十分肮脏）。于是我还是用老办法，使用QEMU模拟之。</p>
<p>
本文所写的方法仅依赖QEMU（需有KVM和VirGL及SDL支持），能够在X和Wayland环境下正常工作。笔者使用的系统为Gentoo、故支持QEMU内UEFI启动的OVMF默认安装路径可能跟你的会有不同。</p>
</div>
</div>
<div id="outline-container-org1d2291c" class="outline-2">
<h2 id="org1d2291c"><span class="section-number-2">2.</span>
安装有KVM／VirGL和SDL支持的QEMU（非Gentoo用家可跳过）</h2>
<div class="outline-text-2" id="text-2"></div>
<div id="outline-container-org689b414" class="outline-3">
<h3 id="org689b414"><span class="section-number-3">2.1.</span>
本体</h3>
<div class="outline-text-3" id="text-2-1">
<p>在Gentoo下，安装<code>app-emulation/qemu</code>，并确保其启用了以下两个USE旗标：</p>
<pre class="example">
+ + sdl                               : Enable the SDL-based console
+ + virgl                             : Enable experimental Virgil 3d (virtual software GPU)
</pre></div>
</div>
<div id="outline-container-org692eff9" class="outline-3">
<h3 id="org692eff9"><span class="section-number-3">2.2.</span> EDK
II OVMF</h3>
<div class="outline-text-3" id="text-2-2">
<p>
为了支持UEFI，我们还需要安装<code>sys-firmware/edk2-ovmf</code>。它会被安装至路径：</p>
<pre class="example">
total 6.2M
-rw-r--r-- 1 root root  16K Aug 28  2022 EnrollDefaultKeys.efi
-rw-r--r-- 1 root root 1.9M Aug 28  2022 OVMF_CODE.fd
-rw-r--r-- 1 root root 1.9M Aug 28  2022 OVMF_CODE.secboot.fd
-rw-r--r-- 1 root root 128K Aug 28  2022 OVMF_VARS.fd
-rw-r--r-- 1 root root 887K Aug 28  2022 Shell.efi
-rw-r--r-- 1 root root 1.5M Aug 28  2022 UefiShell.img
</pre></div>
</div>
</div>
<div id="outline-container-org67bcbd4" class="outline-2">
<h2 id="org67bcbd4"><span class="section-number-2">3.</span>
取得Android-x86系统镜像</h2>
<div class="outline-text-2" id="text-3">
<p>于<a href=
"https://sourceforge.net/projects/android-x86/files/"><code>https://sourceforge.net/projects/android-x86/files/</code></a>下载系统镜像。除该项目之外，你还可以选择其他的项目，如开发更活跃、引入新特性更多的BlissOS。</p>
</div>
</div>
<div id="outline-container-orga683b58" class="outline-2">
<h2 id="orga683b58"><span class="section-number-2">4.</span>
安装虚拟机</h2>
<div class="outline-text-2" id="text-4"></div>
<div id="outline-container-org6b508a1" class="outline-3">
<h3 id="org6b508a1"><span class="section-number-3">4.1.</span>
启动脚本</h3>
<div class="outline-text-3" id="text-4-1">
<p>
新建一个文件夹，将取得的系统镜像重命名为<code>android-x86.iso</code>后存入该路径。随后在该文件夹中创建名为<code>LaunchD.sh</code>的脚本，内容如下：</p>
<div class="org-src-container">
<pre class="src src-shell"><span style=
"color: #b22222;">#</span><span style=
"color: #b22222;">!/usr/bin/</span><span style=
"color: #a020f0;">sh</span>

<span style="color: #a0522d;">VM_PATH</span>=<span style=
"color: #8b2252;">"/home/$(whoami)/Android"</span>

<span style="color: #a0522d;">args</span>=(
  -enable-kvm
  -bios <span style=
"color: #8b2252;">"/usr/share/edk2-ovmf/OVMF_CODE.fd"</span>
  -m 8G
  -smp $(($(nproc)/2))
  -device intel-hda
  -device hda-duplex
  -device virtio-vga-gl
  -display sdl,<span style="color: #a0522d;">gl</span>=on
  -hda <span style="color: #8b2252;">"$VM_PATH/android.img"</span>
  -cdrom <span style=
"color: #8b2252;">"$VM_PATH/android-x86.iso"</span>
)

qemu-system-x86_64 <span style=
"color: #8b2252;">"${args[@]}"</span>
</pre></div>
<p>其中需要注意的是：</p>
<ul class="org-ul">
<li><code>bios</code>指定OVMF的路径、可能需要根据你的发行版安装的位置进行调整；</li>
<li><code>m</code>和<code>smp</code>请根据实际情况调整；</li>
<li><code>intel-hda</code>和<code>hda-duplex</code>为音频系统相关。</li>
</ul>
<p>保存并写入脚本后，给予它执行权限：</p>
<div class="org-src-container">
<pre class="src src-shell">chmod +x LaunchD.sh
</pre></div>
</div>
</div>
<div id="outline-container-org30691c7" class="outline-3">
<h3 id="org30691c7"><span class="section-number-3">4.2.</span>
创建虚拟磁盘</h3>
<div class="outline-text-3" id="text-4-2">
<p>为存放我们的Android虚拟机，我们需要创建一个虚拟磁盘，如以下命令以创建一个60G的磁盘：</p>
<div class="org-src-container">
<pre class="src src-shell">qemu-img create -f qcow2 android.img 60G
</pre></div>
<p>
需要注意，<code>60G</code>为该磁盘的最大大小，也即该文件的最大大小；文件的实际大小会随其中实际装载的数据的大小而变化。</p>
</div>
</div>
<div id="outline-container-orgd736c27" class="outline-3">
<h3 id="orgd736c27"><span class="section-number-3">4.3.</span>
安装</h3>
<div class="outline-text-3" id="text-4-3">
<p>运行脚本启动该虚拟机。按照<a href=
"https://www.android-x86.org/installhowto.html">官方指南</a>安装即可。</p>
</div>
</div>
</div>
<div id="outline-container-org2ac295b" class="outline-2">
<h2 id="org2ac295b"><span class="section-number-2">5.</span>
优化／配置</h2>
<div class="outline-text-2" id="text-5"></div>
<div id="outline-container-orgac559f8" class="outline-3">
<h3 id="orgac559f8"><span class="section-number-3">5.1.</span>
调整屏幕分辨率／尺寸参数</h3>
<div class="outline-text-3" id="text-5-1">
<p>首先如下修改启动脚本，添加窗口尺寸参数：</p>
<div class="org-src-container">
<pre class="src src-diff"><span style=
"background-color: #ffeeee;">&lt;</span><span style=
"background-color: #ffeeee;">   -device virtio-vga-gl,xres=2160,yres=1440</span>
<span style="background-color: #d9d9d9;">---</span>
&gt;   -device virtio-vga-gl
</pre></div>
<p>随后启动虚拟机，并于启动加载器选择DEBUG模式，进入MirBSD Korn Shell环境。随后在其中执行：</p>
<div class="org-src-container">
<pre class="src src-shell">mkdir /boot/
mount /dev/sda1 /boot/
vi /boot/efi/boot/android.cfg
</pre></div>
<p>进行以下修改：</p>
<div class="org-src-container">
<pre class="src src-diff"><span style=
"background-color: #d9d9d9;">@@ -10,7 +10,7 @@</span>
   set kd=$2
   shift 3
<span style="background-color: #ffeeee;">-</span><span style=
"background-color: #ffeeee;">  linux $kd/kernel root=/dev/ram0 $src $@</span>
<span style="background-color: #eeffee;">+</span><span style=
"background-color: #eeffee;">  linux $kd/kernel root=/dev/ram0 $src $@ </span><span style="background-color: #bbffbb;">nomodeset video=2160*1440</span>
   initrd $kd/initrd.img

<span style="background-color: #d9d9d9;">@@ -49,6 +49,7 @@</span>
   loadfont DejaVuSansMono-18
<span style="background-color: #eeffee;">+</span><span style=
"background-color: #eeffee;">  set gfxmode=2160x1440</span>
   terminal_output gfxterm
   set theme=$prefix/theme/theme.txt
</pre></div>
<p>最后清理：</p>
<div class="org-src-container">
<pre class="src src-shell">umount /dev/sda1
rm -r /boot/
<span style="color: #a020f0;">exit</span>
</pre></div>
</div>
</div>
</div>
<div id="outline-container-orged0666a" class="outline-2">
<h2 id="orged0666a"><span class="section-number-2">6.</span>
写在最后</h2>
<div class="outline-text-2" id="text-6">
<p>如此，我们可以实现一个较高性能的安卓虚拟机，而且是在较为干净的情况下。至于为什么不用GTK显示前端，因为它不好！</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: RadioNoiseE</p>
<p class="date">Created: 2024-11-06 Wed 21:27</p>
<p class="validation"><a href=
"https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
